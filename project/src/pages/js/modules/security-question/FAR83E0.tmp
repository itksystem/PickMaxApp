class ChangeSecurityQuestionManager {
    constructor() {
        this.api = new WebAPI();
        this.webRequest = new WebRequest();    
        this.addEventListeners();
    }

    addEventListeners(data) {
     let o = this;	
     window.addEventListener('DOMContentLoaded', () => {

      });
   }

   changeCodeActionResult(firstCode = null, secondCode = null, status = null){
      return (firstCode != secondCode || !status ) ? false : true; 
   }
    
    nextActionButtonCaption(el, isSuccess){
       el.classList.remove('btn-success');
       el.classList.remove('btn-failed');
       el.classList.add((isSuccess ? 'btn-success' : 'btn-failed' ));
       el.innerText = (isSuccess ? 'Завершить' : 'Повторить' );
       return this;
   }

    nextActionRedirect(isSuccess){
       return (isSuccess ? this.api?.PROFILE ?? ``: this.api?.PROFILE_CHANGE_DIGITAL_CODE ?? ``)
    }

    finalMessage(isSuccess){
       return (!isSuccess)
	   ?  `Возникла ошибка при установке кода! Повторите попытку.`
           :  'Код установлен!';
    }

    setFinalProcessElementVisible(){
       this.secondLogin.virtualKeyboardContainer.classList.add('d-none');
       this.secondLogin.nextActionButton.classList.remove('d-none');
       this.secondLogin.nextActionButton.classList.add('d-block');
       this.secondLogin.timerEl.classList.add('d-none');
    }

    displayFinalMessage(text, isSuccess){
      if(isSuccess) {
   	  this.secondLogin.showPublicMessage(text, true);
         } else 	{
   	  this.secondLogin.showPublicMessage(text, false);
	}
     }	

    mySecurityQuestionBoxDisplay(visible = false) {
    const questionElement = this.container.querySelector('div.question-text-box-label');
    const answerElement = this.container.querySelector('div.answer-text-box-label');
     
     [questionElement, answerElement].forEach(element => {
        element.classList.remove(visible ? 'd-none' : 'd-block');
        element.classList.add(visible ? 'd-block' : 'd-none');
     });
   }	

    createSecurityQuestionSection(data) {
	 let elements = this.getElements() || [];
	 elements.push(
	    DOMHelper.createRadio(
	        -1,
	        "customQuestions",
	        `Укажу свой вопрос`,
		false,
		this.radionButtonOnClick.bind(this)
	        ),
	    DOMHelper.divBox(`Введите свой вопрос`,`question-text-box-label w-100 pb-2 pt-3 d-none`),
            DOMHelper.createTextBox(`question-text-box`,`question-text-box form-control w-100 d-none`),
	    DOMHelper.divBox(`Введите ответ`,`w-100 pb-2 pt-3 answer-text-box-label`),
            DOMHelper.createTextBox(`answer-text-box`,`answer-text-box form-control w-100`),
  	    DOMHelper.bottomDrawer(`content-drawer`, ``),
            DOMHelper.createHL(),
            DOMHelper.createButton("Установить проверку", "btn-success text-center w-100", this.saveSecurityQuestion.bind(this)),
            DOMHelper.createBR(),
            DOMHelper.createLinkButton(
                `О контрольном вопросе`,
                `text-end pt-4 security-question-button question-button`, 
                this.onAboutSecurityQuestionClick.bind(this)
            ),

         )   
        this.container =  DOMHelper.createDropdownSection("",  	   
	    elements,
        );
	return this.container;
    }

      radionButtonOnClick(){
	
       console.log(`radionButtonOnClick`, this);
	
      }	

      onAboutSecurityQuestionClick() {
	    this.drawer = this.container.querySelector('[drawer-id="content-drawer"]');
	    console.log(this.drawer);
    
	    if (!this.drawer) {
	        console.error('Element with drawer-id="content-drawer" not found');
	        return this;
	    }

            if(eventBus) {
                console.log(eventBus)
                eventBus.emit("ContentBottomDrawerOpen", { // Убрать двойную вложенность
		        contentId: `about-security-question-help`,
		        drawerId: this.drawer.getAttribute('drawer-id')		    
               });
   	    }	
	    return this;
	}



    saveSecurityQuestion(){
        try {
	    const selectedQuestion = this.container.querySelector('input[name="customQuestions"]:checked');	
   	    console.log(selectedQuestion);
 	    let factorId     = selectedQuestion.value;
	    const myQuestion = this.container.querySelector('textarea[id="question-text-box"]');	
   	    console.log(myQuestion);
	    let factorText   = myQuestion.value; 
	    let answerText   = ``; 
	    let requestId    =  this.requestId; 
            const response   =  this.webRequest.post(this.api.setSecurityQuestionMethod(), 
              { factorId, factorText, answerText, requestId }, 
	      true);
	    if(response?.status != true) throw('Ошибка при получении вопросов');
            return response?.questions || [];
        } catch (error) {
            console.error('Ошибка при получении вопросов:', error);
            toastr.error('Ошибка при получении вопросов', 'Безопасность', { timeOut: 3000 });
            return [];
        }
    }

    // Отображение вопросов в интерфейсе
    getElements() {
	    try {
	        const questions = this.getSecurityQuestions();

	        const elements = questions.map(question => 
	            DOMHelper.createRadio(
	                question.questionId,
	                "customQuestions",
	                `${question.question}`,
	                 null,
			 this.radionButtonOnClick.bind(this)
	            )
	        );
                              
	        return elements;
	    } catch (error) {
	        console.error('Ошибка при получении вопросов:', error);
	        toastr.error('Ошибка при получении вопросов', 'Безопасность', { timeOut: 3000 });
	        return [];
	    }
      }


    getSecurityQuestions() {
        try {
            const response =  this.webRequest.get(this.api.getSecurityQuestionsMethod(), {}, true);
	    if(response?.status != true) throw('Ошибка при получении вопросов');
            return response?.questions || [];
        } catch (error) {
            console.error('Ошибка при получении вопросов:', error);
            toastr.error('Ошибка при получении вопросов', 'Безопасность', { timeOut: 3000 });
            return [];
        }
    }

}


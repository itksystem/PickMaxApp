const USER_DELIVERY_ADDRESS_LOAD_MESSAGE = 'USER_DELIVERY_ADDRESS_LOAD_MESSAGE';
const EVENT_SET_DEFAULT_DELIVERY_ADDRESS = 'EVENT_SET_DEFAULT_DELIVERY_ADDRESS';
const EVENT_RELOAD_ADDRESS_DIALOG = "reloadAddressDialog";
const EVENT_BASKET_ITEM_UPDATE = "basketItemUpdated";
const EVENT_POSTAL_UNIT_UPDATE = "EVENT_POSTAL_UNIT_UPDATE";


class MainApp {
   constructor() {
    this.config = {
      feature: true,
      console: true
    };
      this.api = new WebAPI();
      this.page = 1; // Номер текущей страницы
      this.limit = 6; // Количество товаров для загрузки за раз
      this.loading = false; // Флаг, чтобы предотвратить повторную загрузку данных   
      this.common = new CommonFunctions();
      this.common.init();
      this.common.saveAccessToken(this.common.me);
      this.common.saveTelegramAccessToken(this.common.me);
      this.common.saveTelegramWebAppObject();
      this.init();	
      return this;
   }

 init(){
   let me = this.common.me;
   if(me.isTelegramAuth == true  // для телеграмм-авторизации
	&& me.pinCodeEnabled  	//  если установлен пин-код
		&& !me.pinCodeChecked  // пин-код не введен
			&& window.location.pathname != this.api.PIN_CODE_LOGON_PAGE) // не на странице авторизации
   document.location.replace(this.api.PIN_CODE_LOGON_PAGE);
 }

 showCaseEmptyPageOutput(){
  return `
	<section class="error-page error-page-option text-center page-padding block-space">
	    <span class="error-page-title center-text">Сервис товаров временно недоступен</span>
	</section>`;
 }
  
showCasePage() {
    try {
        let o = this;
        let webRequest = new WebRequest();
        const urlParams = new URLSearchParams(window.location.search);
        const active = urlParams.get('active'); // Оставлено, если будет использоваться в будущем
        
        // Добавляем флаг для отслеживания наличия дополнительных товаров
        o.hasMoreProducts = true;
        
        // Добавляем debounce для обработчика скролла
        let scrollTimeout;
        const scrollHandler = function() {
            clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(function() {
                // Проверяем, нужно ли загружать новые товары
                if (o.hasMoreProducts && 
                    !o.loading && 
                    $(window).scrollTop() + $(window).height() >= $(document).height() - 100) {
                    o.page++;
                    loadProducts(o.page);
                }
            }, 200);
        };

        function loadProducts(page) {
            if (o.loading || !o.hasMoreProducts) return;
            o.loading = true;
            
            // Показываем индикатор загрузки
            $("div.product-card-container").append('<div class="loading-indicator">Загрузка...</div>');
            
            webRequest.post(
                o.api.getShopProductsMethod(), 
                {page, limit : o.limit}, 
                false
            )
            .then(function(data) {
                // Удаляем индикатор загрузки
                $(".loading-indicator").remove();
                
                if (data.length === 0) {
                    o.hasMoreProducts = false;
                    // Если это первая загрузка и нет товаров - показываем пустую страницу
                    if (page === 1) {
                        $("div.product-card-container").html(o.showCaseEmptyPageOutput()).show();
                    }
                    return;
                }
                
                // Если это первая страница - очищаем контейнер
                if (page === 1) {
                    $("div.product-card-container").empty();
                }
                
                data.forEach(product => {
		 if(product?.productId && product?.productId !== '') {
                    const productCard = document.createElement('product-card');
                    productCard.setAttribute('product-id', product?.productId);
                    productCard.setAttribute('like', product?.like || 0);
                    productCard.setAttribute('status', 'active');
                    productCard.setAttribute('image-src', product?.mediaFiles[0]?.mediaKey || '');
                    productCard.setAttribute('image-alt', product?.productName || '');
                    productCard.setAttribute('brand', product?.brandName || '');
                    productCard.setAttribute('name', product?.productName || '');
                    productCard.setAttribute('current-price', product.price || 'цена не указана');
                    productCard.setAttribute('old-price', product?.priceOld || ``);
                    productCard.setAttribute('currency-type', product?.charCurrency ||'₽');
                    productCard.setAttribute('aria-label', product?.productName || '');
                    productCard.setAttribute('basket-count', product?.basketCount || 0);                    
                    document.querySelector("div.product-card-container").appendChild(productCard);
		   }	
                });
                
                // Если получено меньше товаров чем лимит - значит это последняя страница
                if (data.length < o.limit) {
                    o.hasMoreProducts = false;
                }
            })
            .catch(function(error) {
                $(".loading-indicator").remove();
                console.error('initializeProductCard.Произошла ошибка =>', error);
                
                // Показываем ошибку только при первой загрузке
                if (page === 1) {
                    $("div.product-card-container").html(o.showCaseEmptyPageOutput()).show();
                }
                toastr.error('Ошибка при получении товаров', 'Товары', {timeOut: 3000});
            })
            .finally(function() {
                o.loading = false;
            });
        }

        // Изначально загружаем первую страницу товаров
        loadProducts(o.page);

        // Устанавливаем обработчик скролла
        $(window).on('scroll', scrollHandler);

        // Добавляем метод для очистки
        o.cleanupShowCase = function() {
            $(window).off('scroll', scrollHandler);
        };

    } catch (e) {
        console.error('initializeProductCard.catch =>', e);
        $("div.product-card-container").html(this.showCaseEmptyPageOutput()).show();
    }
    return this;
}



/* Вывод страницы профиля */
 showBasketPage() {
  let o = this;
  let webRequest = new WebRequest();
  let request = webRequest.get(o.api.getShopBasketMethod(),  {}, false )
     .then(function(data) {
           console.log(data)
  	   const basketPage = new BasketSection("basket-container");
           const totalQuantity = data?.basket?.reduce((quantity, item) => quantity + item.quantity, 0);
 	   basketPage.BasketCardContainer(totalQuantity, data?.totalAmount, data);
  	   basketPage.render();
            data.basket.forEach(item => {
		new BasketItem("basket-body-container", item);
           });
        })                                
     .catch(function(error) {
       console.log('showBasketOutput.Произошла ошибка =>', error);
     });
    return this;
 }


/* Вывод страницы отзывов */
 showReviewsPage() {
  let o = this;
  let webRequest = new WebRequest();
  const url = window.location.pathname; // Получаем путь 
  const match = url.match(/\/reviews\/([^/]+)\/page/);
  o.productId = match ? match[1] : null;
  console.log(o.productId);

  let request = webRequest.get(o.api.getShopProductDetailsMethod(o.productId),  {}, false )
     .then(function(product) {
       const reviewsPage = new ReviewsCardPage("reviews-card-container");
       reviewsPage.ReviewsContainer(product);
       let getReviewRequest = webRequest.get(o.api.getReviewsMethod(o.productId),  {}, false )
        .then(function(data) {
           console.log(data)                        
  	   reviewsPage.render();

	 if(data.reviews.length) {
            data.reviews.forEach(item => {
		new ReviewItem("review-items-box", item);
            });
	  } else {
	    reviewsPage.ReviewsEmptyPage();
	 }
        })                    
     .catch(function(error) {
       console.log('showReviewsPage.Произошла ошибка =>', error);
     })
    })                                
    .catch(function(error) {
       console.log('showReviewsPage.Произошла ошибка =>', error);
     });       
    return this;
 }

 loader(show = false){
  let _loader = document.querySelector('custom-loader.product-mail-card-container');
  if(_loader) {
    ((show )
      ?  _loader.open()
      :  _loader.close());
    }
 }

/* Вывод страницы почтового обмена по продукту */
 showProductMailPage() {
  let o = this;
  let webRequest = new WebRequest();
  const url = window.location.pathname; // Получаем путь 
  const match = url.match(/\/products\/([^/]+)\/mails\/page/);
  o.productId = match ? match[1] : null;
  console.log(o.productId);

  let request = webRequest.get(o.api.getShopProductDetailsMethod(o.productId),  {}, false )
     .then(function(product) {
       const mailPage = new ProductMailPage("product-mail-card-container");
       mailPage.ProductMailContainer(product);
       mailPage.render();

       let getProductMailRequest = webRequest.get(o.api.getProductMailMethod(o.productId),  {}, false )
        .then(function(data) {
         console.log(data)                        
	 if(data?.mails?.length) {
 	    o.loader(true);
            data?.mails?.forEach(item => {
	      new ProductMailItem("mail-items-box", item);
            });
 	    o.loader(false);
          } else {
	      mailPage.ProductMailEmptyPage();
	   }
        })                                
     .catch(function(error) {
       console.log('showMailsPage.Произошла ошибка =>', error);
	mailPage.ProductMailEmptyPage();
        o.loader(false);
     })
    })                                
    .catch(function(error) {
       console.log('showMailsPage.Произошла ошибка =>', error);
       mailPage.ProductMailEmptyPage();
       o.loader(false);
     });       
    return this;
 }


/* Вывод страницы переписки с пользователем почтового обмена по продукту */
 showProductMailReplyPage() {
  let o = this;
  let webRequest = new WebRequest();
  const url = window.location.pathname; // Получаем путь 
  const match = url.match(/\/products\/([^/]+)\/mail-reply\/([^/]+)\/page/);
   
  o.productId = match ? match[1] : null;
  o.userId = match ? match[2] : null;
  console.log(match, o.productId,o.userId);

  let request = webRequest.get(o.api.getShopProductDetailsMethod(o.productId),  {}, false )
     .then(function(product) {
       const mailPage = new ProductMailPage("product-mail-card-container");
       mailPage.ProductMailContainer(product);
       mailPage.render();

       let getProductMailRequest = webRequest.get(o.api.getProductMailPersonalMethod(o.productId, o.userId),  {}, false )
        .then(function(data) {
         console.log(data)                        
	 if(data?.mails?.length) {
            data?.mails?.forEach(item => {
	      new ProductMailItem("mail-items-box", item);
            });
	     } else {
	      mailPage.ProductMailEmptyPage();
	   }
        })                                
     .catch(function(error) {
       console.log('showMailsPage.Произошла ошибка =>', error);
	mailPage.ProductMailEmptyPage();
     })
    })                                
    .catch(function(error) {
       console.log('showMailsPage.Произошла ошибка =>', error);
       mailPage.ProductMailEmptyPage();
     });       
    return this;
 }



/* Вывод страницы отзыва пользователя */
 showReviewsMyPage() {
  let o = this;
  let webRequest = new WebRequest();
  const url = window.location.pathname; // Получаем путь 
  const match = url.match(/\/reviews\/([^/]+)\/my\/review\/page/);
  o.productId = match ? match[1] : null;
  console.log(o.productId);

  let request = webRequest.get(o.api.getShopProductDetailsMethod(o.productId),  {}, false )
     .then(function(product) {
       const reviewsPage = new ReviewsCardPage("reviews-card-container");
       reviewsPage.ReviewsContainer(product);
       webRequest.get(o.api?.getReviewMethod(o.productId),  {}, false ).then(function(data) {
            console.log(data)                        
      	    reviewsPage.render();

	 if(data?.reviews?.length > 0) {
            data?.reviews?.forEach(item => {
		new ReviewItem("review-items-box", item);
            });
	  } else {
	    reviewsPage.ReviewsEmptyPage();
	 }
       }).catch(function(error) {
       console.log('showReviewsPage.Произошла ошибка =>', error);
      reviewsPage.ReviewsEmptyPage();
     })
    })                                
    .catch(function(error) {
       console.log('showReviewsPage.Произошла ошибка =>', error);
      reviewsPage.ReviewsEmptyPage();
     });       
     return this;
 }



 showProductDetailsPage() {
  let o = this;
  const urlParams = new URLSearchParams(window.location.search); // Получаем текущий URL
  const url = window.location.pathname; // Получаем путь 
  const match = url.match(/\/products\/([^/]+)\/page/);
  o.productId = match ? match[1] : null;
  console.log(o.productId);

  let webRequest = new WebRequest();
  let request = webRequest.get(o.api.getShopProductDetailsMethod(o.productId),  {}, false )
     .then(function(data) {
           console.log(data)
  	   const productDetailsPage = new ProductDetailsSection("product-details-card-container");
 	   productDetailsPage.ProductDetailsCardContainer(data);
  	   productDetailsPage.render();
        })                                
     .catch(function(error) {
       console.log('showBasketOutput.Произошла ошибка =>', error);
     });
    return this;

 }

  showOrderDeliveryOutput(){
   let o = this;
   let webRequest = new WebRequest();
   const url = window.location.pathname; // Получаем путь, например, /delivery/12345
   const match = url.match(/^\/orders\/delivery\/([^/]+)$/);
   o.referenceId = match ? match[1] : null;
   let order = new OrderDto();
   order.loadFromLocalStorage(this.referenceId);
   console.log(order);

   const options = document.querySelectorAll('.option');
   const confirmButton = document.getElementById('delivery-confirm-button');
   const backButton = document.getElementById('delivery-back-button');
   let selectedOption = null;

   options.forEach(option => {
     option.addEventListener('click', () => {
       if (selectedOption) {
            selectedOption.classList.remove('selected');
            }
       option.classList.add('selected');
       selectedOption = option;
       confirmButton.disabled = false;
      });
   });

   confirmButton.addEventListener('click', () => {
    let api = new WebAPI();
    if (selectedOption) {
       order.setDeliveryId(selectedOption.dataset.type);
       order.saveToLocalStorage(o.referenceId);
       window.location.href = `/orders/payment/${this.referenceId}`; //перешли на платежи
      }
    });

    backButton.addEventListener('click', () => {
        // Возврат на предыдущую страницу
        window.location.href = '/orders/page';
    });

  return this;
 }

 showPaymentPageOutput() {
    const o = this;
    const webRequest = new WebRequest();
    const url = window.location.pathname; // Получаем путь, например, /delivery/12345
    const match = url.match(/^\/orders\/payment\/([^/]+)$/);
    o.referenceId = match ? match[1] : null;

    if (!o.referenceId) {
        console.log("Invalid URL: referenceId not found");
        return;
    }

    const order = new OrderDto();
    order.loadFromLocalStorage(o.referenceId);
    console.log(order);

    const paymentAmount = document.querySelector('[name="payment-amount"]');
    if (paymentAmount) paymentAmount.textContent = order.getTotalAmount();

    const paymentAmountButton = document.querySelector('[name="payment-amount-button"]');
    if (paymentAmountButton) paymentAmountButton.textContent = order.getTotalAmount();

    const cardNumber = document.querySelector('[name="CardNumber"]');
    if (cardNumber) cardNumber.value = '2202002200002222';

    const dateTo = document.querySelector('[name="DateTo"]');
    if (dateTo) dateTo.value = '12/28';

    const confirmButton = document.querySelector('[name="Payment-button"]');
    if (confirmButton) {
        confirmButton.addEventListener('click', () => {
            const secureCode = document.querySelector('[name="SecureCode"]');
             if (secureCode) {
                let result = o.getPaymentResult(order)
                  .then(function(paymentResult) {
                   (paymentResult.status === true)
                     ? window.location.href = `/orders/payment/success/${o.referenceId}`
                     : window.location.href = `/orders/payment/failed/${o.referenceId}`
                   })
                .catch(function(error) {
                  console.log('createOrderButtonEventHadler.Произошла ошибка =>', error);
                  window.location.href = `/orders/payment/failed/${o.referenceId}`;
              });
            } 
        });
    }

    const backButton = document.querySelector('[name="Payment-Cancel-Button"]');
    if (backButton) {
        backButton.addEventListener('click', () => {
            window.location.href = '/orders/page';
        });
    }

    return this;
 }


 getPaymentResult(order) {
    let o = this;
    let webRequest = new WebRequest();
    if (!o.api || typeof o.api.sendPaymentMethod !== 'function') {
        console.log('API метод sendPaymentMethod не найден');
        return Promise.reject('API метод sendPaymentMethod не найден');
    }
     const form = document.querySelector('#payForm'); // Найти форму по ID или другому селектору
     const formData = new FormData(form); // Создать объект FormData
	
     // Собрать все данные в объект
     const paymentDetails = {};
       formData.forEach((value, key) => {
           paymentDetails[key] = value;
       });


    order.paymentDetails = paymentDetails;
    return webRequest.post(o.api.sendPaymentMethod(), order, false)
        .then(function(paymentDetails) {
            console.log(paymentDetails);
            return paymentDetails;
        })
        .catch(function(error) {
            console.log('Ошибка при отправке платежа:', error.message || error);
            window.location.href = '/orders/create-error';
        });
  }


 orderItemCardOutput(item){
   return `
	<section class="outside-city delivery-option page-padding block-space card">
	      <div class="row">		
                <div class="col-5  d-flex align-items-center float-start">		
		   <span style="font-size: 1rem">Заказ № ${item.orderId} <small>от ${item.createdAt}</small></span>		   
                </div>
                <div class="col-2  d-flex align-items-center float-start">
		  <span style="font-size: 1rem"> ${item.itemsCount}</span>		
                </div>
                <div class="col-2  d-flex align-items-center float-start">
		  <span style="font-size: 1rem"> ${item.totalAmount}</span>		
                </div>
                <div class="col-3  d-flex align-items-center float-end">
		  <div class="btn btn-lg ${this.common.ORDER_STATUS[item.status].class}"> ${this.common.ORDER_STATUS[item.status].description}</div>		
                </div>
            </div>
	    
	    <div class="w-100">
	        <div class="delivery-content">
		   <div class="delivery-content-card">
			<div class="row">		
  	   	       	   <div class="col-6">		
		                <ul>
		                </ul>
		            </div>
			   <div class="col-6">		

 			   </div>		
  	   	        </div>		
	           </div>
                </div>
	    </div>
	</section>

   `;
 }

 showOrdersPage(){
  let o = this;
  let webRequest = new WebRequest();
  let request = webRequest.get(o.api.getShopOrdersMethod(), o.api.getShopOrdersMethodPayload(), false )
     .then(function(data) {
  	   const ordersPage = new OrdersSection("orders-container");
 	   ordersPage.OrdersCardContainer(data.orders?.length);
  	   ordersPage.render();

            if(data?.orders?.length != 0) {
              data?.orders?.forEach(item => {
 		new OrderItem("orders-body-container", item);
             });
          }
        })                                
     .catch(function(error) {
       console.log('showOrdersPage.Произошла ошибка =>', error);
     });
    return this;
 }


 showOrderInfoPage(){
  let o = this;
  const url = window.location.pathname; // Получаем путь, например, /delivery/12345
  const match = url.match(/\/orders\/(\d+)\/page/);
  o.orderId = match ? match[1] : null;

  let webRequest = new WebRequest();
  let request = webRequest.get(o.api.getShopOrderMethod(o.orderId), {}, false )
       .then(function(data) {
  	   const ordersPage = new OrderDetailsSection("order-container");
 	   ordersPage.OrderDetailsCardContainer(
		data.order, data.order.itemsCount, data.order.totalAmount);
  	   ordersPage.render();
            if(data?.order.items?.length != 0) {
              data?.order.items?.forEach(item => {
 		new OrderDetailsItem("order-details-body-container", 
		data?.order?.orderId, data?.order?.status, item);
             });
          }
        }) 
     .catch(function(error) {
       console.log('showOrderInfoPage.Произошла ошибка =>', error);
     });

    return this;
 }

  verificationCodeConfirmed(){
   let confirmForm = document.querySelector('dropdown-section.registration-confirm-form');
   if(confirmForm)	
     confirmForm.remove();
   let confirmMessage = document.querySelector('.registration-confirm-message');
   if(confirmMessage)	
     confirmMessage.innerHTML=`Электронный адрес подтвержден`;
 }

 showProfilePage(){
  let o = this;
  let webRequest = new WebRequest();
  let request = webRequest.get(o.api.getShopProfileMethod(), {}, false )
     .then(function(data) {
	  console.log(data);
	  if(!data) {
	       toastr.error('Ой! Что то пошло не так...', 'Профиль клиента', {timeOut: 3000});
	  } else {

	  	 const profilePage = new ProfileSection("profile-card-container");
	 	 profilePage.UserProfileCardContainer(data);
	  	 profilePage.render();
		 if(data?.profile?.confirmed)
			o.verificationCodeConfirmed()

              // Слушатели событий

		const autocomplete = document.getElementById('address');
		 autocomplete
		        .setUrl('/api/bff/client/v1/suggest/address?query=') // Установите URL для поиска
			.setPlaceholder('Введите данные для доставки - город, улицу, дом, квартиру...')
		        .onRequest(() => {
			   console.log('Запрос к API отправлен');
		        })
		        .onLoad((response) => {
		            console.log('Данные загружены', response);
		            if(!response.data) { 
				autocomplete.hideItemsBlock() 
			     } else {
		              (response?.data?.length == 0)
			        ? autocomplete.hideItemsBlock()
		                : response.data.forEach(item => {
		                   autocomplete.dropDownListItemDraw(item, item.fiasId, item.value);
		           });
			  }	
		        })
	        .onSelect((item) => {
              console.log('Выбран элемент', item);
            });

          }
        })                                
     .catch(function(error) {
       console.log('showProfilePage.Произошла ошибка =>', error);
       toastr.error('Ой! Что то пошло не так...', 'Профиль клиента', {timeOut: 3000});
     });
   return this;
 }

  ConfirmationEmailPage(){
    let o = this;
    const confirmationEmailPage = new ConfirmationEmailSection("confirmation-email-container");
    confirmationEmailPage.ConfirmationEmailCardContainer();
    confirmationEmailPage.render();
    return this;
  }

  ConfirmationPhonePage(){
    let o = this;
    const confirmationPhonePage = new ConfirmationPhoneSection("confirmation-phone-container");
    confirmationPhonePage.ConfirmationPhoneCardContainer();
    confirmationPhonePage.render();
    return this;
  }


  BalanceHistoryPage(){
    let o = this;
    const balanceHistoryPage = new BalanceHistorySection("balance-history-card-container");
    balanceHistoryPage.BalanceHistoryCardContainer();
    balanceHistoryPage.render();
    return this;
  }

  ChangeDigitalCodePage(){
    let o = this;
    const digitalCodePage = new ChangeDigitalCodePageSection("digital-code-card-container");
    digitalCodePage.ChangeDigitalCodeCardContainer();
    digitalCodePage.render();
    return this;
  }

  DisableDigitalCodePage(){
    let o = this;
    const digitalCodePage = new DisableDigitalCodePageSection("digital-code-card-container");
    digitalCodePage.DisableDigitalCodeCardContainer();
    digitalCodePage.render();
    return this;
  }

  ChangeSecurityQuestionPage(){
    let o = this;
    const securityQuestionPage = new ChangeSecurityQuestionPageSection("security-question-card-container");
    securityQuestionPage.ChangeSecurityQuestionCardContainer();
    securityQuestionPage.render();
    return this;
  }

  DisableSecurityQuestionPage(){
    let o = this;
    const securityQuestionPage = new DisableSecurityQuestionPageSection("security-question-card-container");
    securityQuestionPage.DisableSecurityQuestionCardContainer();
    securityQuestionPage.render();
    return this;
  }

   PINCodeLogonPage(){
    let o = this;
    const pinCodeLogonPage = new PINCodeLogonPageSection("pincode-logon-container");
    pinCodeLogonPage.PINCodeLogonPageCardContainer();
    pinCodeLogonPage.render();
    return this;
  }



}


